# A GitHub Actions workflow to build the Godot Editor AAR
name: Build Godot Editor AAR

# This allows you to run the workflow manually from the Actions tab
on:
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Target Architecture'
        required: true
        default: 'arm64'
        type: choice
        options:
        - arm64
        - arm32

jobs:
  build:
    # Use a powerful Ubuntu runner provided by GitHub
    runs-on: ubuntu-latest
    name: Build for ${{ inputs.architecture }}

    steps:
    # Step 1: Check out the source code from your repository
    - name: Checkout Godot repository
      uses: actions/checkout@v4

    # Step 2: Set up Java (required for Android builds)
    - name: Set up Java Development Kit
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    # Step 3: Set up Android SDK and NDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # Step 4: Install Godot's build dependencies
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y scons pkg-config libx11-dev libxcursor-dev libxinerama-dev \
        libgl1-mesa-dev libglu1-mesa-dev libasound2-dev libpulse-dev libudev-dev libxi-dev \
        libxrandr-dev yasm

    # Step 5: The main build command!
    # This uses SCons to build the Android editor AAR for the selected architecture.
    # The -j$(nproc) flag uses all available CPU cores to speed up the build.
    - name: Build Godot Editor AAR
      run: |
        # Set the target architecture based on the workflow input
        if [ "${{ inputs.architecture }}" == "arm64" ]; then
          TARGET_ARCH="arm64v8"
        else
          TARGET_ARCH="armv7"
        fi
        
        echo "Building for architecture: ${{ inputs.architecture }} (Android arch: $TARGET_ARCH)"
        scons platform=android target=editor arch=${{ inputs.architecture }} android_arch=$TARGET_ARCH -j$(nproc)

    # Step 6: Upload the final .aar file as a build artifact
    # This makes the file available for you to download.
    - name: Upload AAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: godot-editor-aar-${{ inputs.architecture }}
        path: bin/*.aar
