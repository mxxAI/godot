# A modified version of the official script to build only the Godot Editor AAR
name: Build Godot Editor AAR (Official Method)

on:
  workflow_dispatch:
    inputs:
      godot_version:
        description: 'Godot Git Tag or Branch (e.g., 4.2.1-stable or master)'
        required: true
        default: '4.2.1-stable'
        type: string

# Global Settings from the official script
env:
  SCONS_FLAGS: >-
    dev_mode=yes
    module_text_server_fb_enabled=yes
    tests=no
    swappy=yes

jobs:
  build-android-editor:
    runs-on: ubuntu-latest # Using latest for compatibility, 24.04 can be used too
    name: Build Editor ${{ inputs.godot_version }} (arm64)
    timeout-minutes: 90 # Increased timeout just in case

    steps:
      - name: Checkout Godot Repository (at specific version)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.godot_version }}
          submodules: recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Restore Godot build cache
        uses: ./.github/actions/godot-cache-restore
        with:
          cache-name: android-editor
        continue-on-error: true

      - name: Setup Python and SCons
        uses: ./.github/actions/godot-deps

      - name: Download pre-built Android Swappy Frame Pacing Library
        uses: dsaltares/fetch-gh-release-asset@1.1.2
        with:
          repo: godotengine/godot-swappy
          version: tags/from-source-2025-01-31
          file: godot-swappy.7z
          target: swappy/godot-swappy.7z

      - name: Extract pre-built Android Swappy Frame Pacing Library
        run: 7za x -y swappy/godot-swappy.7z -o${{github.workspace}}/thirdparty/swappy-frame-pacing

      - name: Compilation (C++ part)
        uses: ./.github/actions/godot-build
        with:
          scons-flags: ${{ env.SCONS_FLAGS }} arch=arm64 production=yes
          platform: android
          target: editor

      - name: Save Godot build cache
        uses: ./.github/actions/godot-cache-save
        with:
          cache-name: android-editor
        continue-on-error: true

      - name: Generate Godot editor AAR (Java part)
        run: |
          cd platform/android/java
          ./gradlew generateGodotEditor
          cd ../../..
          echo "Listing generated files:"
          ls -l bin/android_editor_builds/

      - name: Upload Editor AAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: godot-editor-aar-${{ inputs.godot_version }}-arm64
          path: bin/android_editor_builds/*.aar
