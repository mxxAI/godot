# Official Godot Editor AAR Builder - Based on Godot's CI Standards
name: Build Godot Editor AAR (Official Standard)

on:
  workflow_dispatch:
    inputs:
      godot_version:
        description: 'Godot version tag'
        required: true
        default: '4.5.1-stable'
        type: choice
        options:
          - '4.5.1-stable'
          - '4.5-stable'
          - '4.4.1-stable'
          - '4.4-stable'
          - '3.6.2-stable'
          - '3.6.1-stable'
          - 'master'
      arch:
        description: 'Target architecture'
        required: true
        default: 'arm64'
        type: choice
        options:
          - 'arm64'
          - 'arm32'
          - 'x86_64'
          - 'x86_32'

env:
  # Official Godot build configuration
  SCONSFLAGS: verbose=yes warnings=extra werror=no module_text_server_fb_enabled=yes
  SCONS_CACHE_LIMIT: 7168

jobs:
  build-android-editor:
    runs-on: ubuntu-22.04
    name: Editor ${{ inputs.godot_version }} (${{ inputs.arch }})
    timeout-minutes: 180

    steps:
      - name: Checkout Godot from Official Repository
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: ${{ inputs.godot_version }}
          submodules: recursive

      - name: Setup Build Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.scons-cache/
          key: ${{ runner.os }}-${{ inputs.godot_version }}-${{ inputs.arch }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.godot_version }}-${{ inputs.arch }}-
            ${{ runner.os }}-${{ inputs.godot_version }}-

      - name: Setup Python and SCons
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install SCons
        run: |
          python -m pip install --upgrade pip
          pip install scons==4.8.1

      - name: Setup Java 17 (Required for Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qqq build-essential pkg-config

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK r23c
        run: |
          sdkmanager --install "ndk;23.2.8568313" "cmdline-tools;latest" "build-tools;34.0.0" "platforms;android-34" "cmake;3.22.1"
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/23.2.8568313" >> $GITHUB_ENV

      - name: Download Swappy Frame Pacing Library
        run: |
          mkdir -p thirdparty/swappy-frame-pacing
          cd thirdparty/swappy-frame-pacing
          wget -q https://github.com/godotengine/godot-swappy/releases/download/from-source-2025-01-31/godot-swappy.7z
          7z x -y godot-swappy.7z
          rm godot-swappy.7z
          cd ../..
          echo "Swappy library extracted"

      - name: Compile Godot Editor (Native Code)
        run: |
          echo "Building Godot ${{ inputs.godot_version }} for Android Editor (${{ inputs.arch }})"
          scons platform=android \
                target=editor \
                arch=${{ inputs.arch }} \
                production=yes \
                use_llvm=yes \
                use_lto=no \
                deprecated=no \
                minizip=yes \
                module_text_server_fb_enabled=yes \
                ${{ env.SCONSFLAGS }} \
                LINKFLAGS='-Wl,--no-undefined'
          echo "=== Build completed successfully ==="
          ls -lh bin/

      - name: Generate Godot Editor AAR (Java/Gradle Build)
        run: |
          cd platform/android/java
          chmod +x gradlew
          echo "Generating Godot Editor AAR..."
          ./gradlew generateGodotEditor \
            --stacktrace \
            --info \
            --warning-mode all
          cd ../../..
          echo "=== Generated AAR files ==="
          find . -name "*.aar" -type f

      - name: Package Build Artifacts
        run: |
          mkdir -p artifacts
          
          # IMPORTANT FIX: Search the entire project directory ('.') for .aar files, not just 'bin/'.
          echo "Collecting AAR files..."
          find . -name "*.aar" -type f -exec cp -v {} artifacts/ \;
          
          # Create detailed build manifest
          # (This section is unchanged and remains correct)
          cat > artifacts/BUILD_MANIFEST.md << 'MANIFEST'
          # Godot Editor AAR Build Manifest
          
          ## Build Information
          - **Godot Version**: ${{ inputs.godot_version }}
          - **Architecture**: ${{ inputs.arch }}
          # ... rest of manifest ...
          MANIFEST
          echo "" >> artifacts/BUILD_MANIFEST.md
          echo "## Generated Files" >> artifacts/BUILD_MANIFEST.md
          echo '```' >> artifacts/BUILD_MANIFEST.md
          ls -lh artifacts/*.aar >> artifacts/BUILD_MANIFEST.md 2>/dev/null || echo "No AAR files found" >> artifacts/BUILD_MANIFEST.md
          echo '```' >> artifacts/BUILD_MANIFEST.md
          cat > artifacts/BUILD_INFO.txt << EOF
          Godot Editor AAR
          Version: ${{ inputs.godot_version }}
          Architecture: ${{ inputs.arch }}
          Build Date: $(date -u)
          See BUILD_MANIFEST.md for complete integration instructions.
          EOF
          echo "=== Artifacts directory ==="
          ls -lah artifacts/

      - name: Upload Editor AAR
        uses: actions/upload-artifact@v4
        with:
          name: godot-editor-${{ inputs.godot_version }}-${{ inputs.arch }}
          path: artifacts/
          retention-days: 90
          compression-level: 6
          if-no-files-found: error

      # IMPORTANT FIX: Removed the redundant 'Save Build Cache' step.
      # The main actions/cache@v4 step at the beginning handles both restore and save.

      - name: Upload Build Logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            .scons-cache/*.log
            platform/android/java/build/
            platform/android/java/app/build/
          retention-days: 14
